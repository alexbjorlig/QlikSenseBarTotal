define(["jquery","./initialproperties","./properties","./lib/js/extensionUtils","text!./lib/css/style.css","./lib/external/d3.min"],function(a,b,c,d,e){"use strict";return d.addStyleToHeader(e),{initialProperties:b,definition:{type:"items",component:"accordion",items:{dimensions:{uses:"dimensions",min:1,max:1},measures:{uses:"measures",min:1,max:1},sorting:{uses:"sorting"},settings:{uses:"settings",items:{colors:{type:"items",label:"Colors",items:{positive:{ref:"bartotal.positivecolor",label:"Positive",type:"string",expression:"optional",defaultValue:"rgb(68,119,170)"},negative:{ref:"bartotal.negativecolor",label:"Negative",type:"string",expression:"optional",defaultValue:"rgb(249,63,23)"},total:{ref:"bartotal.totalcolor",label:"Color",type:"string",expression:"optional",defaultValue:"rgb(123,122,120)"}}},total:{type:"items",label:"Show total bar",items:{total:{type:"string",component:"switch",label:"Enable Totals",ref:"bartotal.total",options:[{value:!0,label:"Show"},{value:!1,label:"Hide"}],defaultValue:!0},totalLabel:{ref:"bartotal.totalLabel",label:"Label",type:"string",expression:"optional",defaultValue:"Total",show:function(a){return a.bartotal.total}},reverse:{type:"string",component:"switch",label:"Reverse placement",ref:"bartotal.reverse",options:[{value:!0,label:"True"},{value:!1,label:"False"}],defaultValue:!1,show:function(a){return a.bartotal.total}}}},data:{type:"items",label:"Datapoints",items:{abbr:{type:"string",component:"switch",label:"Abbreviate numbers",ref:"bartotal.abbr",options:[{value:!0,label:"Yes"},{value:!1,label:"No"}],defaultValue:!0},datapoints:{ref:"bartotal.dataPoints",label:"Datapoints",component:"dropdown",options:[{value:"no",label:"No datapoints"},{value:"exp",label:"Expression value"},{value:"cum",label:"Cumulative"}],type:"string",defaultValue:"exp"}}},axis:{type:"items",label:"Axis",items:{xaxis:{type:"string",component:"switch",label:"X-Axis",ref:"bartotal.xaxis",options:[{value:!0,label:"Show"},{value:!1,label:"Hide"}],defaultValue:!0},yaxis:{type:"string",component:"switch",label:"Y-Axis",ref:"bartotal.yaxis",options:[{value:!0,label:"Show"},{value:!1,label:"Hide"}],defaultValue:!0}}},space:{type:"items",label:"Spacing",items:{bar_padding:{type:"number",component:"slider",label:"Space between bars",ref:"bartotal.bar_padding",min:0,max:1,step:.05,defaultValue:[.1]}}}}}}},snapshot:{canTakeSnapshot:!0},paint:function(a,b){function c(a){if(!d.$scope.$parent.$parent.editmode&&"total"!=a.element&&-2!=a.element){if(d.selectValues(0,[a.element],!0),0===d.selectedArrays[0].length)return void D.selectAll("rect").style("opacity",1);D.selectAll("rect").style("opacity",.4),D.selectAll("rect").each(function(){var a=d3.select(this),b=a.attr("id");d.selectedArrays[0].forEach(function(c){return b==c?a.style("opacity",1):void 0})})}}a.empty();var d=this,e=b.qHyperCube.qDimensionInfo[0].qApprMaxGlyphCount<5?5:b.qHyperCube.qDimensionInfo[0].qApprMaxGlyphCount,f=9*e,g=!1,h=b.qHyperCube.qDimensionInfo[0].qGroupFieldDefs[0],i=0==h.toLocaleLowerCase().indexOf("=valueloop")||0==h.toLocaleLowerCase().indexOf("=valuelist"),j=b.bartotal.dataPoints,k=b.bartotal.total,l=b.bartotal.reverse,m=b.bartotal.xaxis,n=b.bartotal.yaxis,o=b.bartotal.abbr,p=d3.format(".4s"),q=(b.bartotal.inverse,{top:20,right:55,left:55,bottom:55}),r=b.qHyperCube.qDimensionInfo[0].othersLabel,s=b.qHyperCube.qDataPages[0].qMatrix.filter(function(a){return void 0!==a[0].qText||a[0].qIsOtherCell}).map(function(a,b,c){return{label:a[0].qIsOtherCell?r:a[0].qText,value:a[1].qNum,element:a[0].qElemNumber,sum:0===b?a[1].qNum:c.map(function(a){return a[1].qNum}).reduce(function(a,c,d){return d>b?a:a+c})}}),t=s.reduce(function(a,b){return a+b.value},0);k&&(l?s.unshift({label:b.bartotal.totalLabel,value:t,element:"total",sum:t}):s.push({label:b.bartotal.totalLabel,value:t,element:"total",sum:t}));var u=a.width()-q.left-q.right,v=1.05*d3.max(s,function(a){return a.sum}),w=0,x=d3.scale.ordinal().rangeRoundBands([0,u],b.bartotal.bar_padding).domain(s.map(function(a){return a.label}));f>55&&(q.bottom=f,g=!0),f>x.rangeBand()&&(q.bottom=55,g=!0);var y=a.height()-q.top-q.bottom,z=d3.scale.linear().domain([w,v]).range([w,y]),A=d3.scale.linear().domain([w,v]).range([y,w]),B=d3.svg.axis().scale(A).orient("left").tickFormat(d3.format("s")),C=d3.svg.axis().scale(x).orient("bottom"),D=d3.select(a.get(0)).selectAll("svg").data([null]).enter().append("svg").attr("width",u+q.left+q.right).attr("height",y+q.top+q.bottom).append("g").attr("transform","translate("+q.left+","+q.top+")");D.selectAll("rect").data(s).enter().append("rect").attr("id",function(a){return a.element}).attr("class",function(a){return a.label===b.bartotal.totalLabel?"total":a.value<0?"negative":"positive"}).attr("x",function(a){return x(a.label)}).attr("y",function(a){return y-z(a.value)}).attr("width",x.rangeBand()).attr("height",function(a){return z(Math.abs(a.value))}).style("fill",function(a){if(a.label===b.bartotal.totalLabel)return b.bartotal.totalcolor;var c=a.value<0?b.bartotal.negativecolor:b.bartotal.positivecolor;return c}),i||D.selectAll("rect").style("cursor","pointer").on("click",c);D.append("g").selectAll("text").data(s).enter().append("text").attr("x",function(a){return x(a.label)+x.rangeBand()/2}).attr("y",function(a){return y-z(a.value)}).attr("dy",-5).attr("text-anchor","middle").text(function(a){var b="";return"exp"==j?b=o?p(a.value):a.value:"cum"===j&&(b=o?p(a.sum):a.sum),b});n&&D.append("g").attr("class","yaxis axis").call(B),m&&D.append("g").attr("class","xaxis axis").attr("transform","translate(0,"+y+")").call(C),m&&g&&D.selectAll(".xaxis text").style("text-anchor","end").attr("transform",function(){return"translate(-8,0)rotate(-45)"})}}});